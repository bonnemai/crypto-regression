worker_processes  1;

events {
  worker_connections 1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  keepalive_timeout  65;

  # Permit DNS resolution for upstream HTTPS origin
  resolver 1.1.1.1 1.0.0.1 valid=300s;
  resolver_timeout 10s;

  server {
    listen 8080;
    server_name _;

    # Health check endpoint
    location = /healthz {
      add_header Content-Type application/json;
      return 200 '{"status":"ok"}';
    }

    # Proxy Bitfinex public API while applying permissive CORS headers
    location /bitfinex/ {
      # Strip /bitfinex prefix when calling upstream
      proxy_pass https://api-pub.bitfinex.com/;
      proxy_ssl_server_name on;
      proxy_http_version 1.1;
      proxy_set_header Host api-pub.bitfinex.com;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_redirect off;

      # Allow client-side apps to call through the proxy
      add_header Access-Control-Allow-Origin "*";
      add_header Access-Control-Allow-Credentials "false";
      add_header Access-Control-Allow-Methods "GET, OPTIONS";
      add_header Access-Control-Allow-Headers "$http_access_control_request_headers";

      # Respond to preflight requests locally so they do not reach the upstream
      if ($request_method = OPTIONS) {
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }
  }
}
